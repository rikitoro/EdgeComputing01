# エッジコンピューティング開発実習 1

## IoT 歩数計システムの開発

この実習では歩数計を IoT 化したシステムを構築します。


---

## システムの全体構成

<img src="./fig/system.png" alt="システムの全体構成">

開発するシステムは、利用者が身に付けて使う歩数計(以下 IoT デバイスと呼ぶ)と、IoT デバイスから送られるデータを蓄積するデータベースなどのサーバ(以下、クラウドサーバ)からなります。

M5Stack (Gray) をウェアラブルな歩数計とみなし、利用者はこの歩数計を身に着けて利用します。
歩数計は M5Stack (Gray) に内蔵された加速度センサーにより利用者の歩行を検出し、歩数をカウントします。
さらに、歩数計は直近 1 分間での利用者の歩数と現在時刻を利用者の活動情報として、 1 分ごとにクラウドサーバ上に構築されたデータベースへと送信します。

クラウドサーバは IoT デバイスから受信したデータをデータベースに記録していきます。これによってあとから、利用者の歩行履歴を確認できるようになります。

---

## IoTデバイス側の要件

### 使用器材

- M5Stack Gray (IMUを内蔵したもの)

### IoTデバイスに求められる機能

1. ネットワークおよびクラウドサーバへの接続 : インターネットに接続された Wi-Fi アクセスポイントへ無線接続し、実習用の Node-RED サーバへデータを送信できるようにします。

2. 時刻の取得 : NTPプロトコルによりデバイス内部の時計を現在時刻に同期させ、現在時刻の UNIX time を取得できるようにします。

3. 歩数のカウント : 加速度センサから得られるデータを分析して、利用者の歩行を検出し、歩数をカウントします。

4. 活動情報の送信 : 1 分間隔で利用者の「活動情報」を実習用 Node-RED サーバに構築したデータベースへ送信します。
ここで「活動情報」は以下の表により定義します。

[表1.「活動情報」の定義]

| 項目 | 内容 |
|---|---|
| timestamp | データ送信時点の UNIX time (整数値) |
| step | 直近 1 分間の歩数 (整数値) |

---

## クラウドサーバ側の要件

実習用に準備された Node-RED サーバを用いてシステムを構築します。
データベースマネージメントシステムとして Node-RED へ SQLite を事前にインストールしてください。

1. 「活動情報」記録のためのテーブルの構築 : 利用者の「活動情報」を記録するためのテーブルを作成します。

2. 「活動情報」のデータベースへの記録 : IoT デバイス (歩数計) から送信されてくる「活動情報」を受信するたびにそのデータを 1. で作成したテーブルへ記録します。

---
## 発展課題

1. M5Stack のLCD に現在の時刻や、歩数のカウント値を表示出来るようにしてみましょう。ボタンで表示を切り替えるようにしてもよいです。

2. Node-RED上に構築したデータベースと連携し、「活動情報」の履歴が表やグラフで表示される Web ページを作成してみましょう。

---

## 参考

- [M5Stack で現在時刻を取得する](./ntp_unixtime)
- [M5Stack Gray で加速度センサを使用する](./imu_accel)
- [Node-RED にSQlite データベースを構築する](./sqlite_on_nodered)



